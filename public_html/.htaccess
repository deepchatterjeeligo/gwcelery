# Reverse proxies for Flask and Tornado web applications.
RewriteEngine on

# Define some lookup tables.
RewriteMap flower_port_map "txt:flower-ports.txt"
RewriteMap gwcelery_port_map "txt:gwcelery-ports.txt"

# Within the domain of the cluster we are on (e.g. ligo.caltech.edu,
# ligo-la.caltech.edu, or ligo-wa.caltech.edu), Apache is running on ldas-jobs
# and the web applications are running on emfollow. Determine the hostname of
# the proxied server by replacing "ldas-jobs." with "emfollow.".
RewriteCond "%{SERVER_NAME}" "^ldas-jobs\.(.+)$"
RewriteRule ".*" - [E=PROXIED_SERVER_NAME:emfollow.%1]

# Capture the user from the URI.
RewriteCond "%{REQUEST_URI}" "^/~(.*?)/"
RewriteRule ".*" - [E=TILDE_USER:%1]

# The reverse proxy rules themselves.
RewriteRule ^flower/?(.*)$ http://%{ENV:PROXIED_SERVER_NAME}:${flower_port_map:%{ENV:TILDE_USER}}/$1 [P]
RewriteRule ^gwcelery/?(.*)$ http://%{ENV:PROXIED_SERVER_NAME}:${gwcelery_port_map:%{ENV:TILDE_USER}/$1 [P]
